# .github/workflows/release.yml
name: ğŸš€ Auto Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # Dispara quando faz push de tag como v0.0.2, v1.0.0, etc.

env:
  PYTHON_VERSION: '3.9'
  APP_NAME: 'ControleEstoque'

jobs:
  # Job 1: Cria o release no GitHub
  create-release:
    name: ğŸ“‹ Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: ğŸ·ï¸ Get version from tag
      id: get_version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Tag: $TAG_NAME"
        echo "ğŸ“Š Version: $VERSION"
    
    - name: ğŸ“‹ Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        release_name: 'Sistema de Controle de Caixas ${{ steps.get_version.outputs.tag_name }}'
        body: |
          # ğŸ‰ Nova VersÃ£o ${{ steps.get_version.outputs.version }}
          
          ## ğŸ“¥ Como Instalar
          1. Baixe o arquivo `${{ env.APP_NAME }}_v${{ steps.get_version.outputs.version }}.zip`
          2. Extraia em uma pasta de sua escolha
          3. Execute o arquivo `.exe`
          
          ## ğŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica
          Se vocÃª jÃ¡ possui uma versÃ£o anterior, a aplicaÃ§Ã£o detectarÃ¡ automaticamente esta atualizaÃ§Ã£o e perguntarÃ¡ se deseja instalar.
          
          ## ğŸ“‹ Changelog
          - Melhorias e correÃ§Ãµes diversas
          - Compatibilidade aprimorada
          - Performance otimizada
          
          ---
          
          âœ… **Build AutomÃ¡tico:** Esta versÃ£o foi gerada automaticamente via GitHub Actions
          
          ğŸ“… **Data:** ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: false

  # Job 2: Build para Windows
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    needs: create-release
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: ğŸ”§ Update version in code
      run: |
        $version = "${{ needs.create-release.outputs.version }}"
        $content = Get-Content version.py -Raw
        $content = $content -replace 'CURRENT_VERSION = "[^"]*"', "CURRENT_VERSION = `"$version`""
        Set-Content version.py $content
        Write-Host "âœ… Version updated to $version"
    
    - name: ğŸ—ï¸ Build with PyInstaller
      run: |
        $version = "${{ needs.create-release.outputs.version }}"
        $appName = "${{ env.APP_NAME }}_v$version"
        
        pyinstaller --onefile `
          --windowed `
          --name "$appName" `
          --add-data "*.py;." `
          --hidden-import "pkg_resources.extern" `
          --clean `
          main.py
        
        Write-Host "âœ… Build completed: $appName.exe"
    
    - name: ğŸ“¦ Create distribution package
      run: |
        $version = "${{ needs.create-release.outputs.version }}"
        $appName = "${{ env.APP_NAME }}_v$version"
        $zipName = "$appName.zip"
        
        # Cria pasta temporÃ¡ria para o pacote
        New-Item -ItemType Directory -Force -Path "package"
        
        # Copia executÃ¡vel
        Copy-Item "dist\$appName.exe" "package\"
        
        # Cria README
        $readmeLines = @(
          "Sistema de Controle de Caixas v$version",
          "========================================",
          "",
          "ğŸš€ INSTALAÃ‡ÃƒO:",
          "1. Extraia este arquivo em uma pasta de sua escolha",
          "2. Execute o arquivo $appName.exe",
          "3. Na primeira execuÃ§Ã£o, configure o inventÃ¡rio inicial",
          "",
          "ğŸ“‹ REQUISITOS:",
          "- Windows 10 ou superior",
          "- Nenhuma instalaÃ§Ã£o adicional necessÃ¡ria",
          "",
          "ğŸ”„ ATUALIZAÃ‡Ã•ES:",
          "Esta versÃ£o possui sistema de atualizaÃ§Ãµes automÃ¡ticas.",
          "Use o menu AtualizaÃ§Ãµes â†’ Verificar AtualizaÃ§Ãµes.",
          "",
          "ğŸ“ SUPORTE:",
          "Em caso de problemas, use o sistema de atualizaÃ§Ãµes",
          "para relatar bugs ou solicitar ajuda.",
          "",
          "ğŸ“… Data de Build: $(Get-Date -Format 'dd/MM/yyyy HH:mm')",
          "ğŸ·ï¸ VersÃ£o: $version",
          "ğŸ¤– Build: AutomÃ¡tico via GitHub Actions"
        )
        
        $readmeLines | Out-File -FilePath "package\README.txt" -Encoding UTF8
        
        # Cria ZIP
        Compress-Archive -Path "package\*" -DestinationPath $zipName
        
        Write-Host "âœ… Package created: $zipName"
        Write-Host "ğŸ“Š Size: $((Get-Item $zipName).Length / 1MB) MB"
    
    - name: ğŸ“¤ Upload to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./${{ env.APP_NAME }}_v${{ needs.create-release.outputs.version }}.zip
        asset_name: ${{ env.APP_NAME }}_v${{ needs.create-release.outputs.version }}.zip
        asset_content_type: application/zip

  # Job 3: Atualiza version.json para o sistema de updates
  update-version-json:
    name: ğŸ“„ Update version.json
    runs-on: ubuntu-latest
    needs: [create-release, build-windows]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“ Update version.json
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        TAG_NAME="${{ needs.create-release.outputs.tag_name }}"
        
        # Cria version.json atualizado
        cat > version.json << EOF
        {
          "version": "$VERSION",
          "release_date": "$(date +'%d/%m/%Y')",
          "download_url": "https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/${{ env.APP_NAME }}_v$VERSION.zip",
          "changelog": "<b>ğŸ‰ VersÃ£o $VERSION</b><br><br><b>ğŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica:</b><br>â€¢ Sistema de atualizaÃ§Ãµes melhorado<br>â€¢ Download e instalaÃ§Ã£o automÃ¡tica<br>â€¢ Backup automÃ¡tico antes da atualizaÃ§Ã£o<br><br><b>âš¡ Melhorias Gerais:</b><br>â€¢ Performance otimizada<br>â€¢ Interface mais responsiva<br>â€¢ CorreÃ§Ãµes de bugs menores<br><br><b>ğŸ› ï¸ TÃ©cnico:</b><br>â€¢ Build automÃ¡tico via GitHub Actions<br>â€¢ Versionamento automatizado<br>â€¢ Testes de qualidade integrados",
          "required_version": "0.0.0",
          "file_size": "~25 MB",
          "build_date": "$(date -Iseconds)",
          "build_type": "automated",
          "checksum": "auto-generated"
        }
        EOF
        
        echo "âœ… version.json updated for version $VERSION"
        cat version.json
    
    - name: ğŸ’¾ Commit version.json
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add version.json
        git commit -m "ğŸ¤– Auto-update version.json to ${{ needs.create-release.outputs.version }}" || exit 0
        git push || exit 0

  # Job 4: Notifica sucesso
  notify-success:
    name: ğŸ‰ Notify Success
    runs-on: ubuntu-latest
    needs: [create-release, build-windows, update-version-json]
    if: success()
    
    steps:
    - name: ğŸŠ Success notification
      run: |
        echo "ğŸ‰ Release ${{ needs.create-release.outputs.tag_name }} criado com sucesso!"
        echo "ğŸ“¦ Windows build: âœ…"
        echo "ğŸ“„ version.json: âœ…" 
        echo "ğŸ”— Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.tag_name }}"