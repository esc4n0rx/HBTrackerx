name: ğŸš€ Release AutomÃ¡tico

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pandas PyQt5 openpyxl requests

    - name: ğŸ”§ Build application
      run: |
        pyinstaller --onefile --windowed --name "ControleEstoque" --icon=icon.ico main.py

    - name: ğŸ“‹ Prepare release info
      id: release_info
      run: |
        $VERSION = "${{ github.ref_name }}"
        $COMMIT_MSG = git log -1 --pretty=%B
        
        $RELEASE_BODY = @"
        # ğŸ‰ HB Tracker $VERSION

        ## ğŸ“¦ Download
        Baixe o arquivo **ControleEstoque.exe** abaixo e execute diretamente.

        ## âœ¨ Novidades desta versÃ£o
        $COMMIT_MSG

        ## ğŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica
        Se vocÃª jÃ¡ possui uma versÃ£o anterior, a aplicaÃ§Ã£o detectarÃ¡ automaticamente esta atualizaÃ§Ã£o e perguntarÃ¡ se deseja instalar.

        ## ğŸ“‹ Principais Funcionalidades
        - âœ… **InventÃ¡rio Inicial:** Carregamento de estoque base das lojas
        - âœ… **Controle de Movimentos:** Remessas, regressos e transferÃªncias
        - âœ… **Fluxo Visual:** Acompanhe mudanÃ§as dia a dia
        - âœ… **RelatÃ³rios Completos:** ExportaÃ§Ã£o em Excel/CSV
        - âœ… **AtualizaÃ§Ãµes AutomÃ¡ticas:** Sistema sempre atualizado
        - âœ… **Multi-Local:** CDs e Lojas integrados

        ## ğŸ› ï¸ Como usar
        1. Baixe o arquivo ControleEstoque.exe
        2. Execute o arquivo (Windows pode pedir confirmaÃ§Ã£o)
        3. FaÃ§a upload do inventÃ¡rio inicial nas configuraÃ§Ãµes
        4. Importe os movimentos via menu Arquivo

        ---

        âœ… **Build AutomÃ¡tico:** Esta versÃ£o foi gerada automaticamente via GitHub Actions

        ğŸ“… **Data:** $(Get-Date -Format 'dd/MM/yyyy HH:mm:ss')
        "@
        
        # Salva em arquivo para usar no prÃ³ximo step
        $RELEASE_BODY | Out-File -FilePath "release_body.txt" -Encoding utf8

    - name: ğŸš€ Create Release with GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create "${{ github.ref_name }}" `
          ./dist/ControleEstoque.exe `
          --title "HB Tracker ${{ github.ref_name }}" `
          --notes-file release_body.txt `
          --latest